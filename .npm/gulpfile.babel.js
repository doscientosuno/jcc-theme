import path from 'path'
import gulp from 'gulp'
import gulpLoadPlugins from 'gulp-load-plugins'
import browserSyncLib from 'browser-sync'
import pjson from './package.json'
import minimist from 'minimist'
import wrench from 'wrench'

// Load all gulp plugins based on their names
// EX: gulp-copy -> copy
const plugins = gulpLoadPlugins()
// Create karma server
const KarmaServer = require('karma').Server

let config = pjson.config
let args = minimist(process.argv.slice(2))
let dirs = config.directories
let taskTarget = args.production ? dirs.destination : dirs.temporary

// Create a new browserSync instance
let browserSync = browserSyncLib.create()

// This will grab all js in the `gulp` directory
// in order to load all gulp tasks
wrench.readdirSyncRecursive('./gulp')
.filter(file => (/\.(js)$/i).test(file))
.map(function (file) {
  let module = require('./gulp/' + file)
  module.default(gulp, plugins, args, config, taskTarget, browserSync)
})

// Default task
gulp.task('default', ['clean'], () => {
  gulp.start('build')
})

// Build production-ready code
gulp.task('build', [
  'copy',
  'imagemin',
  'sass',
  'browserify'
])

// Server tasks with watch
gulp.task('serve', [
  'imagemin',
  'copy',
  'sass',
  'browserify',
  'browserSync',
  'watch'
])

// Testing
gulp.task('test', ['eslint'], (done) => {
  new KarmaServer({
    configFile: path.join(__dirname, '/karma.conf.js'),
    singleRun: !args.watch,
    autoWatch: args.watch
  }, done).start()
})
